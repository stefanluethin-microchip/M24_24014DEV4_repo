#!/usr/bin/env groovy

// This file was generated by the CI/CD Wizard version 1.0.375.
// See the user guide for information on how to customize and use this file.
//-SL: Jenkins Pipeline syntax type = Declarative

pipeline {
    environment {
        DEMO_V = "demo_simple_d1"
		JPIPELINE = "files_cicd/Jenkinsfile_d2_mdb_24014dev4"
		 //-SL: root path to tools and IDE
        MPLABX_ROOT = "/opt/microchip/mplabx"
        MPLABX_V_2_USE = "v6.20"
        MPLABX_EXE = "mplab_ide"
         //-SL: /opt/microchip/mplabx/v6.20/mplab_platform/bin/mplab_ide
        MPLABX_EXE_2_USE = "${MPLABX_ROOT}" + "/" + "${MPLABX_V_2_USE}" + "/mplab_platform/bin/" + "${MPLABX_EXE}"
         //-SL: /opt/microchip/mplabx/v6.20/mplab_platform/bin/xclm
        XCLM_EXE = "xclm"
        XCLM_EXE_2_USE   = "${MPLABX_ROOT}" + "/" + "${MPLABX_V_2_USE}" + "/mplab_platform/bin/" + "${XCLM_EXE}"
         //-SL: /opt/microchip/xc32/v4.40/bin/xc32-gcc
        XC32_ROOT = "/opt/microchip/xc32"
        XC32_V_2_USE = "v4.40"
        XC32_GCC_EXE = "xc32-gcc"
        XC32_GCC_2_USE = "${XC32_ROOT}" + "/" + "${XC32_V_2_USE}" + "/bin/" + "${XC32_GCC_EXE}"       
         //-SL: see <https://www.jenkins.io/doc/book/pipeline/jenkinsfile/#using-environment-variables>
         //-SL:  which env-variables are known
         //-SL:  eg ${env.WORKSPACE} points to '/var/lib/jenkins/nodes/DEM-LT-M16422u_localJenkinsAgent/workspace/J_test3/'
         //-SL:   for Node/Agent/Slave/Client 'J_test3' created in Jenkins-Master/-Server
        PRJ_DIR_N=   "CICDgh_samd21xplp"
         //-SL: path-2-MPLABX-prj.X relative from Jenkins-Workspace as scripts below first cd's into WS
        PRJ_X_NAME =   "CICDgit_samd21xplp.X"
        PRJ_WS_REL_P = "./" + "${PRJ_DIR_N}" + "/firmware/" + "${PRJ_X_NAME}"
        MPLABX_CFG_N = "samd21xplp"
        PRJ_MK_STR =   "${PRJ_WS_REL_P}" + "@" + "${env.MPLABX_CFG_N}"
		 //-prjMakefilesGenerator to read MPLABX-configuration.xml and create Makefiles
		PRJ_MK_GEN_CALL = "${MPLABX_ROOT}" + "/" + "${MPLABX_V_2_USE}" + "/mplab_platform/bin/" + "prjMakefilesGenerator.sh"
         //-SL: simple bash-scrp to find *.elf-file and print path+name
        ELF_TEST_SCR = "./" + "result_check.sh"
		ELF_TEST_SCR_FULLP="${env.PRJ_WS_REL_P}" + "/" + "result_check.sh"
		 //-mdb call
		MDB_CALL = "CICDgh_samd21xplp/" + "mdb/" + "CICDgh_samd21xplp_test3b_mdbbat-run.sh"
    }
    agent any
    
    stages {
        stage('Build') {
            steps {
                 sh(
                    label: 'environment check',
                    script: """
						    set +x
                            echo "###-SL: ========================================================================"
                            echo "###-SL:       Jenkins-Pipeline ${env.JPIPELINE}"
							echo "###-SL:       from ${env.JOB_NAME}"
							echo "###-SL:       START stage:build/step:environment check"
                            echo "###-SL: ========================================================================"
							set -x
                            echo "###-SL: Running ${env.BUILD_ID} on ${env.JENKINS_URL}"
							echo "###-SL: prj_root_p = ${env.PRJ_ROOT_P}"							
                            echo "###-SL: WS = ${env.WORKSPACE}"
							echo "###-SL: ========================================================================"
                            echo "###-SL:       END stage:build/step:environment check"
                            echo "###-SL: ========================================================================"
							set -x
                            """
                   ) //-SL: end 'step: env-check'
                 sh(
                     label: 'cleanup (if needed)',
                     script: """
                            set +x
                            echo "###-SL: ========================================================================"
							echo "###-SL:       START stage:build/step:cleanup"
                            echo "###-SL: ========================================================================"
							cd ${env.WORKSPACE}
                            rm -rf ./build
                            rm -rf ./dist
                            rm -rf ./debug
                            rm -rf .generated_files/
                            rm -rf nbproject/Makefile-*
                            rm -rf nbproject/Package-samd21xplp.bash
                            rm -rf nbproject/private
							echo "###-SL: ========================================================================"
                            echo "###-SL:       END stage:build/step:cleanup"
                            echo "###-SL: ========================================================================"	
							set +x
                            """
                 ) //-SL: end 'step: cleanup'
                 sh(
                     label: 'Generate build makefiles',
                     script: """
                            set +x
                            echo "###-SL: ======================================================================== "
							echo "###-SL:       START stage:build/step:re-creating makefiles for ${PRJ_MK_STR}"
                            echo "###-SL: ======================================================================== "
							echo "###-SL: re-creating makefiles for ${env.PRJ_MK_STR}"
							#-SL: prjMakefilesGenerator.sh reads the MPLABX-file configuration.xml and out of it creates Makefiles
                             #-/opt/microchip/mplabx/v6.20/mplab_platform/bin/prjMakefilesGenerator.sh -v -f ./CICDgh_samd21xplp/firmware/CICDgit_samd21xplp.X@samd21xplp
							"${PRJ_MK_GEN_CALL}" -v -f ${PRJ_WS_REL_P}@${env.MPLABX_CFG_N}
							echo "###-SL: ========================================================================"
                            echo "###-SL:       END stage:build/step:re-creating makefiles"
                            echo "###-SL: ========================================================================"	
							set +x
                            """
                 ) //-SL: end 'step: create/update Makefiles'
                 sh(
                     label: 'compile = running Makefile',
                     script: """
							set +x
                            echo "###-SL: ========================================================================"
							echo "###-SL:       START stage:build/step: compile=make"
                            echo "###-SL: ========================================================================"
                            cd "${env.PRJ_WS_REL_P}"
                            echo "###SL: current path `pwd`"
                            make clean
                            make CONF="${env.MPLABX_CFG_N}"
							echo "###-SL: ========================================================================"
                            echo "###-SL:       END stage:build/step:compile=make"
                            echo "###-SL: ========================================================================"	
							set +x
                            """
                 ) //-SL: end 'step: compile-w-make'
                 sh(
                     label: 'compile successful?',
                     script: """
                            set +x
                            echo "###-SL: ========================================================================"
							echo "###-SL:       START stage:build/step: result-check"
                            echo "###-SL: ========================================================================"
							cd "${env.PRJ_WS_REL_P}"
							chmod +x ${ELF_TEST_SCR}
                            ${ELF_TEST_SCR}
							echo "###-SL: ========================================================================"
                            echo "###-SL:       END stage:build/step:result-check"
                            echo "###-SL: ========================================================================"	
							set +x
                            """
                 ) //-SL: end 'step: result-check'
				 
            } //-end 'steps' in 'stage=build'
        } //-end stage=build
		
        stage('HWrun') {
            steps {

                 sh(
                    label: 'mdb-run_envCheck',
                    script: """
						    set +x
                            echo "###-SL: ========================================================================"
                            echo "###-SL:  START mdbbat/hw-in-th-loop run from ${env.WORKAREA}"
							echo "###-SL:   stage:HWrun / step: mdb-run_envCheck"
                            echo "###-SL: ========================================================================"
							  #-SL: CICDgh_samd21xplp/mdb/CICDgh_samd21xplp_test1a_Setup_env.sh
							  #-SL: not needed, as setup above for compile already
							  which mdb || ECHO "###-SL--------: mdb.bat not found, stop here"
							echo "###-SL: ========================================================================"
                            echo "###-SL:       END stage:HWrun / step: mdb-run_envCheck"
                            echo "###-SL: ========================================================================"	
							set +x
                            """
                   ) //-end 'step=mdb-run_envCheck'
                 sh(
                    label: 'compile_elfExistsCheck',
                    script: """
						    set +x
                            echo "###-SL: ========================================================================"
                            echo "###-SL: START stage:HWrun / step: compile_elfExistsCheck"
                            echo "###-SL: ========================================================================"
							${ELF_TEST_SCR_FULLP}
							echo "###-SL: ========================================================================"
                            echo "###-SL:       END stage:HWrun / step: compile_elfExistsCheck"
                            echo "###-SL: ========================================================================"	
							set +x
                            """
                   ) //-end 'step=compile_elfExistsCheck'
                 sh(
                    label: 'mdbbat_HW_in_loop_run',
                    script: """
						    set +x
                            echo "###-SL: ========================================================================"
                            echo "###-SL: START stage:HWrun / step: mdbbat_HW_in_loop_run"
                            echo "###-SL: ========================================================================"
							 #-chmod +x CICDgh_samd21xplp/mdb/CICDgh_samd21xplp_test3b_mdbbat-run.sh 
							 #-CICDgh_samd21xplp/mdb/CICDgh_samd21xplp_test3b_mdbbat-run.sh
							chmod +x ${MDB_CALL}
							${MDB_CALL}
							echo "###-SL: ========================================================================"
                            echo "###-SL:       END stage:HWrun / step: mdbbat_HW_in_loop_run"
                            echo "###-SL: ========================================================================"	
							set +x
                            """
                   ) //-end 'step=mdbbat_HW_in_loop_run'
            } //-end 'steps' in 'stage=HWrun'
        } //-end stage=HWrun

    } //-end 'stages'
    
    post {
        //-SL: there're different outcomes 'sucess, failure,..., always' of the
		//-SL:  stages-step that are optional, hence don't have to be specified
        always {
            // Clean workspace after build
            echo "###-SL: ========================================================================"
			echo "###-SL: post / always from current Jenkins-Pipeline ${env.JPIPELINE}"
            echo "###-SL: ========================================================================"				
            //cleanWs()   //-Jenkins-buildin fct to cleanup Workspace
        }
        success {
            echo "###-SL: ========================================================================"
			echo "###-SL: post / success from current Jenkins-Pipeline ${env.JPIPELINE}"
            echo "###-SL: ========================================================================"
        }
		
    }  //-end 'post'

} //- end 'pipeline'
